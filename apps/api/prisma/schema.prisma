generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum HouseholdRole {
  OWNER
  MEMBER
}

enum PactStatus {
  PENDING
  DOING
  DONE
}

enum PactActivityType {
  CREATED
  UPDATED
  ASSIGNED
  UNASSIGNED
  STATUS_CHANGED
  DONE
  CONFIRMED
  COMMENT
}

enum DevicePlatform {
  ios
  android
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  passwordHash      String
  name              String
  refreshTokens     RefreshToken[]
  memberships       HouseholdMember[]
  createdPacts      Pact[]             @relation("PactCreator")
  assignedPacts     Pact[]             @relation("PactAssignee")
  activities        PactActivity[]     @relation("ActivityUser")
  deviceTokens      DeviceToken[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String
  tokenHash   String
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Household {
  id          String             @id @default(uuid())
  name        String
  members     HouseholdMember[]
  invites     HouseholdInvite[]
  pacts       Pact[]
  activities  PactActivity[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model HouseholdMember {
  id           String        @id @default(uuid())
  householdId  String
  userId       String
  role         HouseholdRole
  createdAt    DateTime      @default(now())

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
}

model HouseholdInvite {
  id          String   @id @default(uuid())
  householdId String
  code        String   @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
}

model Pact {
  id                    String         @id @default(uuid())
  householdId           String
  title                 String
  notes                 String?
  createdByUserId       String
  assignedToUserId      String?
  dueAt                 DateTime?
  status                PactStatus     @default(PENDING)
  requiresConfirmation  Boolean        @default(false)
  doneAt                DateTime?
  confirmedAt           DateTime?
  overdueNotifiedAt     DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  household        Household      @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy        User           @relation("PactCreator", fields: [createdByUserId], references: [id])
  assignedTo       User?          @relation("PactAssignee", fields: [assignedToUserId], references: [id])
  activities       PactActivity[]
}

model PactActivity {
  id           String            @id @default(uuid())
  pactId       String
  householdId  String
  byUserId     String
  type         PactActivityType
  payload      Json
  createdAt    DateTime          @default(now())

  pact      Pact      @relation(fields: [pactId], references: [id], onDelete: Cascade)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  byUser    User      @relation("ActivityUser", fields: [byUserId], references: [id])

  @@index([householdId, createdAt, id])
}

model DeviceToken {
  id            String         @id @default(uuid())
  userId        String
  expoPushToken String         @unique
  platform      DevicePlatform
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
